<html>
<head>
	<style type="text/css">
		html, body {
			background-color: #886028;
			font-family: 'Sans Serif';
		}
		
		button#go, button#finalize {
			font-size: 1.3em;
			padding:5px;
			margin-right: 60px;
		}
		
		.left {
			float: left;
		}
		
		.option-list > div {
			margin-right: 40px;
		}
		
		.option-list::after {
			clear: both;
			content: "";
			display: table;
		}
		
		label, select {
			display: block;
			padding: 5 0px;
		}
		
		label > span {
			min-width: 140px;
			display: inline-block;
			font-weight: bold;
		}
		
		
		label > input {
			width: 70px;
			display: inline-block;
			text-align: right;
			padding: 3px;
		}
		
		.cost {
			text-align: right;
		}
		.avail{
			text-align: center;
		}
		.reroll {
			text-align: center;
		}
		.menu {
			
			
		}
		
		.item {
			padding: 5px;
		}
		
		
		.item-table {
			margin-top: 20px;
			border-collapse: collapse;
		}
		.item-table th {
			padding: 3px 10px;
			border: 1px solid black;
		}
		
		.item-table td {
			padding: 3px 10px;
		}
		.item-table tbody tr:nth-child(odd) {
			background-color: #997039;
		}
		
	
	</style>
	<script type="text/javascript">var module = {};</script>
	<script src="itemList.js"></script>
	
	<script type="text/javascript">
		/*
		art, gems, statues, etc.
		"mundane"
		attachment, ie. finger, shoulder, hat, etc.
		scrolls
		
		*/
	
		/*
		for(var m of module.exports.minor_item_list) {
			if(!module.exports.items[m]) console.log('missing:', m);
		}
		*/
		
		function clone(obj) {
			var o = {};
			for(var k in obj) {
				var v = obj[k];
				
				if(typeof v == 'object') {
					if(v instanceof Array) o = [];
					o[k] = clone(v);
				}
				else {
					o[k] = v;
				}
			}
			return o;
		}
		
		
		var magic_ammo_rarity = {
			1: 'uncommon',
			2: 'rare',
			3: 'very rare',
		}
		var magic_weapon_rarity = {
			1: 'uncommon',
			2: 'rare',
			3: 'very rare',
		}
		var magic_armor_rarity = {
			1: 'rare',
			2: 'very rare',
			3: 'legendary',
		}
		
		var armor_of_resistance_types = [
			"Acid",
			"Cold",
			"Fire",
			"Force",
			"Lightning",
			"Necrotic",
			"Poison",
			"Psychic",
			"Radiant",
			"Thunder",
		];
		
		var scroll_level_data = {
			0: {name: 'Cantrip', rarity: 'common', save_dc: 13, attack_bonus: 5},
			1: {name: '1st', rarity: 'common', save_dc: 13, attack_bonus: 5},
			2: {name: '2nd', rarity: 'uncommon', save_dc: 13, attack_bonus: 5},
			3: {name: '3rd', rarity: 'uncommon', save_dc: 15, attack_bonus: 7},
			4: {name: '4th', rarity: 'rare', save_dc: 15, attack_bonus: 7},
			5: {name: '5th', rarity: 'rare', save_dc: 17, attack_bonus: 9},
			6: {name: '6th', rarity: 'very rare', save_dc: 17, attack_bonus: 9},
			7: {name: '7th', rarity: 'very rare', save_dc: 18, attack_bonus: 10},
			8: {name: '8th', rarity: 'very rare', save_dc: 18, attack_bonus: 10},
			9: {name: '9th', rarity: 'legendary', save_dc: 19, attack_bonus: 11},
		};
		
		// fill in all the ammo
		for(var owi in module.exports.items) {
			var ow = module.exports.items[owi];
			if(!(ow.type == 'ammunition' && ow.rarity == 'common' && !ow.magic_item)) continue;
			
			for(var b = 1; b <= 3; b++) {
				var nw = clone(ow);
				nw.name += ', +' + b;
				nw.id = owi + ', +' + b;
				nw.magic_item = true;
				nw.rarity = magic_ammo_rarity[b];
				nw.attack_bonus = b;
				nw.damage_bonus = b;
				
				module.exports.items[nw.id] = nw;
				module.exports.minor_item_list.push(nw.id);
			}
		}
		
		// fill in all the weapons
		for(var owi in module.exports.items) {
			var ow = module.exports.items[owi];
			if(!(ow.type == 'weapon' && ow.rarity == 'common' && !ow.magic_item)) continue;
			
			for(var b = 1; b <= 3; b++) {
				var nw = clone(ow);
				nw.name += ', +' + b;
				nw.id = owi + ', +' + b;
				nw.magic_item = true;
				nw.rarity = magic_weapon_rarity[b];
				nw.attack_bonus = b;
				nw.damage_bonus = b;
				
				module.exports.items[nw.id] = nw;
			}
		}
		
		// fill in all the armor
		for(var oai in module.exports.items) {
			var oa = module.exports.items[oai];
			if(!(oa.type == 'armor' && oa.rarity == 'common' &&  !oa.magic_item)) continue;
			
			for(var b = 1; b <= 3; b++) {
				var na = clone(oa);
				na.name += ', +' + b;
				na.id = oai + ', +' + b;
				na.magic_item = true;
				na.rarity = magic_armor_rarity[b];
				na.ac_bonus = b;
				module.exports.items[na.id] = na;
				
				// armor of resistance
				for(var dtype of armor_of_resistance_types) {
					var na = clone(oa);
					na.name += ' of Resistance, ' + dtype;
					na.id = oai + ' of resistance, ' + dtype.toLowerCase();
					na.magic_item = true;
					na.rarity = 'rare';
					na.ac_bonus = b;
					module.exports.items[na.id] = na;
				}
			}
			
			if((oa.subtype == 'medium' || oa.subtype == 'heavy') && oa.id != 'hide') {
				// mithral
				var na = clone(oa);
				na.name = 'Mithral ' + na.name;
				na.id += 'mithral ' + oai;
				na.magic_item = true;
				na.rarity = 'uncommon';
				na.mithral = true;
				na.min_str = '-';
				delete na.stealth;
				module.exports.items[na.id] = na;
				module.exports.minor_item_list.push(na.id);
				
				// adamantium
				var na = clone(oa);
				na.name = 'Adamantine ' + na.name;
				na.id += 'adamantine ' + oai;
				na.magic_item = true;
				na.rarity = 'uncommon';
				na.adamantium = true;
				module.exports.items[na.id] = na;
			}
		}
		
		// fill in the scrolls
		for(var spi in module.exports.spell_list) {
			var sp = module.exports.spell_list[spi];
			
			var ld = scroll_level_data[sp.level];
			var sc = {
				id: "scroll of " + sp.id,
				name: "Scroll of " + sp.name,
				type: "Scroll",
				level: sp.level,
				school: sp.school,
				magic_item: true,
				rarity: ld.rarity,
				attack_bonus: ld.attack_bonus,
				save_dc: ld.save_dc,
			};
			
			module.exports.items[sc.id] = sc;
			module.exports.minor_item_list.push(sc.id);
		}
		
		
		function $all(sel, n) {
			return (n || document).querySelectorAll(sel);
		}

		function $(sel, n) {
			return (n || document).querySelector(sel);
		}
		
		function $ce(tag, classes, content) {
			var n = document.createElement(tag);
			
			if(classes) {
				if(typeof classes == 'string') n.className = classes;
				else if(classes instanceof Array) n.classList = classes;
			}
			
			if(content) {
				if(typeof content == 'string') n.innerHTML = content;
				else if(typeof content == 'number') n.innerHTML = content + '';
				else n.appendChild(content);
			}
			
			return n;
		}
		
		function roll(n, d) {
			var s = 0;
			for(var i = 0; i < n; i++) s += Math.floor((Math.random() * d)) + 1;
			return s;
		}
		
		function makeControl(e) {
			var l = $ce('label');
			l.appendChild($ce('span', '', e.getAttribute('label')));
			
			var c = $ce('input');
			c.type = e.getAttribute('type');
			c.value = e.innerHTML;
			c.id = e.getAttribute('cid');
			
			l.appendChild(c);
			
			e.parentNode.insertBefore(l, e);
			
			e.parentNode.removeChild(e);
			console.log('meh')
		}
		
		window.addEventListener("load", function() {
			
			$all('control').forEach(makeControl);
			
			
			$('#finalize').addEventListener('click', function(e) {
				$('.menu').remove();
				$all('.reroll').forEach(function(x) { x.remove() });
			});
			
			$('#go').addEventListener('click', function(e) {
				e.preventDefault();
				
				$('#finalize').style.display = 'inline-block';
				
				var raw = $('#item-count').value.toLowerCase();
				var [n,d] = raw.split('d');
				
				/* for checking the dice algorithm
				var o = {};
				for(var i = 0; i < n+2; i ++) o[i] = 0;
				for(var i = 0; i < 1000000; i ++){
					o[roll(n,d)]++;
				}
				console.log(o);
				*/
				
				function is_minor(x) {
					var y =  module.exports.minor_item_list.indexOf(x) >= 0;
// 					console.log('is_minor', x, y);
					return y;
				}
				
				function filterItems(rarity, minor) {
// 					console.log(minor);
					var o = [];
					for(var k in module.exports.items) {
						var i = module.exports.items[k];
						if(
							i.rarity == rarity  
// 							&& (is_minor(i.id) == minor)
							&& i.magic_item
							&& !i.pocket_dimension
						) {
							o.push(i);
						}
					}
					
					return o;
				}
				
				function getPrice(rarity, m) {
					switch(rarity) {
						case 'common': return (roll(1, 6) + 1) * 10;
						case 'uncommon': return roll(1, 6) * 100;
						case 'rare': return roll(1, 6) * 1000;
						case 'very rare': return roll(1, 6) * 10000;
						case 'legendary': return roll(2, 6) * 25000;
					};
				}
				
				
				var cont = $('.item-list');
				cont.innerHTML = '';
				
				var max_weapons = parseFloat($('#max-weapons').value);
				var max_armor = parseFloat($('#max-armor').value);
				var max_scrolls = parseFloat($('#max-scrolls').value);
				var icmul = parseFloat($('#item-count').value);
				var pmul = parseFloat($('#price-mul').value);
				var qdice = $('#avail-dice').value.split('d');
				
				function qroll() {
					return roll(qdice[0], qdice[1]);
				}
				function nfmt(s) {
					return String(s).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
				}
				
				function addItem(item, list) {
					var c = $ce('tr', 'item');
					
					var qty = qroll();
					var price = 100 * pmul;
					
					var n_ = $ce('td', 'name', item.name);
					var r_ = $ce('td', 'rarity', item.rarity);
					var q_ = $ce('td', 'avail', qroll());
					var p_ = $ce('td', 'cost', nfmt(getPrice(item.rarity, qty)));
					
					var rm = $ce('button', '', 'X');
					rm.addEventListener('click', function(e) {
						if(list.length == 0) {
							c.remove();
							return;
						};
						var ind = Math.floor(Math.random() * list.length);
						
						var it = list[ind];
						var q = qroll();
						
						n_.innerHTML = it.name;
						r_.innerHTML = it.rarity;
						q_.innerHTML = q;
						p_.innerHTML = nfmt(getPrice(it.rarity, q));
						
						list.splice(ind, 1);
					});
					
					c.appendChild(n_);
					c.appendChild(r_);
					c.appendChild(q_);
					c.appendChild(p_);
					c.appendChild(rm);
					
					c.appendChild($ce('td', 'reroll', rm))
					
					cont.appendChild(c);
				}
				
				
				function filterType(type, list, special) {
					for(var ind in list) {
						var i = list[ind];
						if(i.type == type) {
							special[type].push(i);
							list.splice(ind, 1);
						}
					}
				}
				
				var CRn = $('#tier');
				var CR = CRn.selectedOptions[0].value - 1;
				
				var item_res = {};
				
				for(var sz in module.exports.standard_awards) {
					var z = module.exports.standard_awards[sz];
					
					
					
					for(var r in z) {
						var k = sz + '_' + r;
						var list = filterItems(r, sz == 'minor');
						item_res[k] = list;
						
						var amt = Math.floor((z[r][CR] * icmul) + .5);
						var chosen = [];
						var weapon_cnt = 0;
						var armor_cnt = 0;
						var scrolls_cnt = 0;
						
						var special = {
							weapon: [],
							armor: [],
							Scroll: [],
						};
						
						for(var n = 0; n < amt; n++) {
							if(list.length == 0) break;
							var ind = Math.floor(Math.random() * list.length);
							
							var it = list[ind];
							
							if(it.type == 'weapon') {
								if(++weapon_cnt > max_weapons) {
									filterType('weapon', list, special);
									n--;
									continue;
								}
							}
							
							if(it.type == 'armor') {
								if(++armor_cnt > max_armor) {
									filterType('armor', list, special);
									n--;
									continue;
								}
							}
							
							if(it.type == 'Scroll') {
								if(++scrolls_cnt > max_scrolls) {
									filterType('Scroll', list, special);
									n--;
									continue;
								}
							}
							
							chosen.push(it);
							addItem(it, list, special);
							
							list.splice(ind, 1);
							console.log(n, ind, list);
						}
						
						console.log(sz, r, amt, list.length, chosen);
						
					} 
					
					
				}
				
			})
			
		});
		
		
	</script>
</head>
<body>
	<div class="menu">
		<select id="tier">
			<option value="1">Tier 1:  1-4</option>
			<option value="2" selected>Tier 2:  5-10</option>
			<option value="3">Tier 3: 11-16</option>
			<option value="4">Tier 4: 17-20</option>
		</select>
		
		<div class="option-list">
			<div class="left">
				<control cid="item-count" label="Item Count Mul.:" type="edit">1</control>
				<control cid="price-mul" label="Price Multiplier:" type="edit">1</control>
				<control cid="avail-dice" label="Avail/Price:" type="edit">1d6</control>
			</div>
			<div class="left">
				<label><span>Per Rarity:</span></label>
				<control cid="max-weapons" label="Max Weapons:" type="edit">2</control>
				<control cid="max-armor" label="Max Armor:" type="edit">2</control>
				<control cid="max-scrolls" label="Max Scrolls:" type="edit">2</control>
			</div>
		</div>
		
		<br/>
		<br/>
		<button id="go">Generate</button>
		<button id="finalize" style="display:none;">Finalize</button>
	</div>
	<table class="item-table" >
		<thead>
			<tr>
				<th>Item Name</th>
				<th>Rarity</th>
				<th>Qty.<br/>Available</th>
				<th>Price</th>
				<th class="reroll">Reroll</th>
			</tr>
		</thead>
		<tbody class="item-list"></tbody>
	</table>
	
</body>
</html>
